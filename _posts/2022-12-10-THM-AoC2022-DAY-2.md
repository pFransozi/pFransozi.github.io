---
layout: post
title:  THM AoC 2022 DAY TWO
date:   2022-12-10 18:00:00
description: walking through the second day's topics and diving deeper
tags: ["Log-Files", "Log-Analysis"]
category: ["Try-Hack-Me", "THM-AoC-2022", "Log-Analysis"]
---
## Introduction

The second day focuses on log analysis and the goals are:

* **what** log files are and **why** they're useful;
* **what** valuable information log files can contain;
* **where** log files can be found;
* and some **linux commands** to handle with text log files;

## Log files and log analysis

Log analysis is an important part of cybersecurity, since it can provide valuable insight into potential security threats, involving collection and analysis of various logs generated by various systems, networks, and applications to detect malicious activities and suspicious patterns. Log files can be used to detect intrusions, malware, malicious user activity, and operational errors. Through log analysis, organizations can identify potential security issues and take corrective measures to address them. Log analysis can also be used to detect patterns of malicious behavior and to track user activity for compliance purposes.

In general, log files record data of an event triggered by an application or the own OS, such as:

* user logins and logouts;
* system startup and shutdown;
* application usage;
* configuration changes;
* security events;
* network traffic;
* system errors and warnings;
* user actions;
* resource utilization.

And, in general, data recorded is:

* What has happened?
* When has it happened?
* Where has it happened?
* Who did it? Were they successful?
* What is the result of this action?

Another important aspect of this topic is to know where the files are.

**In Windows**, log files are stored in:

~~~ powershell
%SystemRoot%\System32\Winevt\Logs\
%SystemRoot%\system32\config\
%SystemRoot%\system32\LogFiles\
~~~

~~~ powershell
#
# application log contains information about application events, 
# such as when an application crashes or when an application writes an error to the log.
eventquery /FI "APPLICATION eq MyApplication"

Event Type: Information
Event Source: MyApplication
Event Category: None
Event ID: 1000
Date: 12/09/2022
Time: 10:33:22 AM
User: N/A
Computer: MyComputer
Description:
MyApplication has started successfully.

Event Type: Warning
Event Source: MyApplication
Event Category: None
Event ID: 1001
Date: 12/09/2022
Time: 10:34:15 AM
User: N/A
Computer: MyComputer
Description:
MyApplication has encountered a warning: The database connection has failed.

Event Type: Error
Event Source: MyApplication
Event Category: None
Event ID: 1002
Date: 12/09/2022
Time: 10:35:01 AM
User: N/A
Computer: MyComputer
Description:
MyApplication has encountered an error: The database connection could not be restored.
~~~

~~~ powershell
#
# system log contains information about system-wide events, 
# such as when a service starts or stops, or when a driver is installed.

eventquery /L system

Event Type: Information
Event Source: Service Control Manager
Event Category: None
Event ID: 7036
Date: 12/09/2022
Time: 10:37:22 AM
User: N/A
Computer: MyComputer
Description:
The Network Connections service entered the running state.

Event Type: Warning
Event Source: Windows Update
Event Category: None
Event ID: 1001
Date: 12/09/2022
Time: 10:38:15 AM
User: N/A
Computer: MyComputer
Description:
Windows Update has encountered a warning: Some updates could not be installed.

Event Type: Error
Event Source: System
Event Category: None
Event ID: 6008
Date: 12/09/2022
Time: 10:39:01 AM
User: N/A
Computer: MyComputer
Description:
The previous system shutdown at 10:33:22 AM on ‎12/‎9/‎2022 was unexpected.

~~~

~~~powershell
#
# security log contains information about security-related events, 
# such as when a user logs on or off, or when a user attempts to access a resource.

eventquery /L security

Event Type: Information
Event Source: Security
Event Category: Logon/Logoff
Event ID: 4624
Date: 12/09/2022
Time: 10:40:22 AM
User: N/A
Computer: MyComputer
Description:
An account was successfully logged on.
Subject:
    Security ID:  MYDOMAIN\MyUser
    Account Name: MyUser
    Account Domain: MYDOMAIN
    Logon ID:  0x1f44c

Event Type: Warning
Event Source: Security
Event Category: Account Management
Event ID: 4740
Date: 12/09/2022
Time: 10:41:15 AM
User: N/A
Computer: MyComputer
Description:
A user account was locked out.
Subject:
    Security ID:  MYDOMAIN\MyUser
    Account Name: MyUser
    Account Domain: MYDOMAIN
    Logon ID:  0x1f44c

Event Type: Error
Event Source: Security
Event Category: Access Control
Event ID: 4625
Date: 12/09/2022
Time: 10:42:01 AM
User: N/A
Computer: MyComputer
Description:
An account failed to log on.
Subject:
    Security ID:  NULL SID
    Account Name:  -
    Account Domain: -
    Logon ID:  0x0

~~~

~~~ powershell
#
# setup log contains information about the setup and configuration of Windows,
# such as when an application is installed or uninstalled.

eventquery /L setup

Event Type: Information
Event Source: Microsoft-Windows-Setup
Event Category: None
Event ID: 100
Date: 12/09/2022
Time: 10:43:22 AM
User: N/A
Computer: MyComputer
Description:
The installation of MyApplication has started.

Event Type: Warning
Event Source: Microsoft-Windows-Setup
Event Category: None
Event ID: 101
Date: 12/09/2022
Time: 10:44:15 AM
User: N/A
Computer: MyComputer
Description:
The installation of MyApplication has encountered a warning: One or more required files could not be found.

Event Type: Error
Event Source: Microsoft-Windows-Setup
Event Category: None
Event ID: 102
Date: 12/09/2022
Time: 10:45:01 AM
User: N/A
Computer: MyComputer
Description:
The installation of MyApplication has failed.
~~~

Windows OS has an in-built application that allows to access historical records of events that happen. It is an utility that displays detailed information about significant events from the system, security  and general applications. Windows event viewer can be accessed using the command:

~~~ powershell
#
# graphic
eventvwr

#
# command-line
eventquery /l Application
~~~

---

**In Linux**, the log files are stored in:

~~~ shell
/var/log
~~~

All file logs in Linux are created in that directory by default. Between those files, there are some important ones:

~~~ shell
#
# file contains all authentication (log in). This is usually attempted
# either remotely or on the system itself (i.e., accessing another user after logging in).
tail /var/log/auth.log

Dec  9 10:00:00 hostname sshd[12345]: Accepted password for username from 192.0.2.1 port 12345 ssh2
Dec  9 10:00:01 hostname sshd[12345]: pam_unix(sshd:session): session opened for user username by (uid=0)
Dec  9 10:00:02 hostname sshd[12345]: pam_unix(sshd:session): session closed for user username
~~~

~~~ shell
#
#
tail /var/log/secure

Dec  9 10:00:00 hostname sshd[12345]: Received disconnect from 192.0.2.1: 11: Bye Bye [preauth]
Dec  9 10:00:01 hostname kernel: imklog 4.8.10, log source = /proc/kmsg started.
Dec  9 10:00:02 hostname rsyslogd: [origin software="rsyslogd" swVersion="8.24.0" x-pid="12345" x-info="http://www.rsyslog.com"] start
~~~

~~~ shell
#
#
tail /var/log/firewall.log

Dec  9 10:00:00 hostname kernel: [UFW BLOCK] IN=eth0 OUT= MAC=01:23:45:67:89:ab:01:23:45:67:89:ab:01:23:45:67 SRC=192.0.2.1 DST=192.0.2.2 LEN=40 TOS=0x00 PREC=0x00 TTL=64 ID=12345 DF PROTO=TCP SPT=12345 DPT=22 WINDOW=5840 RES=0x00 SYN URGP=0
Dec  9 10:00:01 hostname kernel: [UFW ALLOW] IN=eth0 OUT= MAC=01:23:45:67:89:ab:01:23:45:67:89:ab:01:23:45:67 SRC=192.0.2.1 DST=192.0.2.2 LEN=40 TOS=0x00 PREC=0x00 TTL=64 ID=12345 DF PROTO=TCP SPT=12345 DPT=22 WINDOW=5840 RES=0x00 SYN URGP=0
~~~

~~~ shell
#
# contains all events related to package management on the system.
# When installing a new software (a package), this is logged in this file. 
# This is useful for debugging or reverting changes in case this installation
# causes unintended behavior on the system.
tail /var/log/dpkg.log

Dec  9 10:00:00 hostname dpkg: status database area is locked by another process
Dec  9 10:00:01 hostname dpkg: starting package configuring
Dec  9 10:00:02 hostname dpkg: package libc6:amd64 successfully configured
~~~

~~~ shell
#
# contains all events related to things happening in the system's background.
# For example, crontabs executing, services starting and stopping, or other 
# automatic behaviors such as log rotation. This file can help debug problems.
tail /var/log/syslog

Dec  9 10:00:00 hostname kernel: [  123.456456] init: Unable to open '/dev/console': No such file or directory
Dec  9 10:00:01 hostname kernel: [  123.456879] init: Could not open the file '/usr/share/systemd/test/test-timeout.sh'
Dec  9 10:00:02 hostname kernel: [  123.457301] init: Failed to create directory '/usr/share/systemd/system-generators/test': No such file or directory
~~~

~~~ shell
#
# contains all events related to kernel events on the system. 
# For example, changes to the kernel, or output from devices 
# such as networking equipment or physical devices such as USB devices.
/var/log/kern.log

Dec  9 10:00:00 hostname kernel: [12345.67890] init: Failed to create directory '/var/lib/systemd/system': No such file or directory
Dec  9 10:00:01 hostname kernel: [12345.67901] init: Could not open the file '/var/lib/systemd/test/test-timeout.sh'
Dec  9 10:00:02 hostname kernel: [12345.67912] init: Failed to create directory '/var/lib/systemd/system-generators/test': No such file or directory
~~~

Another important group of log files are those that are created by other applications such databases, webservices, file and print services, and so on. It's common to have to analyze application logs and, by default, they'are organize in the same root directory. Next some examples:

~~~ shell
#
# MySQL log shows the version of DB, port to connect, and the directory of mysql.sock file, which is a Unix file responsible for communication (ICP), inter-process communication.
# The file log registers the shutdown event.
tail /var/log/mysql/mysql.log

[2022-12-09 10:00:00] [MY-010101] [Server] /usr/sbin/mysqld: ready for connections.
Version: '8.0.22'  socket: '/var/lib/mysql/mysql.sock'  port: 3306  MySQL Community Server - GPL.
[2022-12-09 10:00:01] [MY-010597] [Server] /usr/sbin/mysqld: Normal shutdown.
[2022-12-09 10:00:02] [MY-010226] [Server] InnoDB: Starting shutdown...
[2022-12-09 10:00:03] [MY-010347] [Server] InnoDB: Shutdown completed; log sequence number 0; transaction id 0
[2022-12-09 10:00:04] [MY-010910] [Server] /usr/sbin/mysqld: Shutdown complete
~~~

~~~ shell
#
# a SMBclient program connecting to a server, 
# negotiating the dialect to use for communication, 
# and then listing the contents of a directory on the server.
tail /var/log/samba/samba.log

[2022-12-09 10:00:00] [SMBCLIENT] Opening connection to SERVERNAME as user USERNAME
[2022-12-09 10:00:01] [SMBCLIENT] Connected.
[2022-12-09 10:00:02] [SMBCLIENT] Negotiating dialect.
[2022-12-09 10:00:03] [SMBCLIENT] Dialect negotiated.
[2022-12-09 10:00:04] [SMBCLIENT] Listing directory /share/directory1/
[2022-12-09 10:00:05] [SMBCLIENT] Closing connection to SERVERNAME
~~~

~~~ shell
#
# /var/log/apache2/
# Access login page, log in, and it is redirected to the main page, 
# and start to get the resources.
tail '/var/log/apache2/access.log'

127.0.0.1 - - [09/Dec/2022:15:00:01 +0000] "GET /login HTTP/1.1" 200 1412 "-" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36"
127.0.0.1 - - [09/Dec/2022:15:00:23 +0000] "POST /login HTTP/1.1" 302 - "http://localhost/login" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36"
127.0.0.1 - - [09/Dec/2022:15:00:23 +0000] "GET /home HTTP/1.1" 200 2342 "http://localhost/login" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36"
127.0.0.1 - - [09/Dec/2022:15:00:31 +0000] "GET /image1.png HTTP/1.1" 200 3189 "http://localhost/home" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36"
127.0.0.1 - - [09/Dec/2022:15:00:40 +0000] "GET /image2.png HTTP/1.1" 200 4982 "http://localhost/home" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36"
~~~

~~~ shell
#
#
tail /var/log/vsftpd.log

Dec  9 10:00:00 ftp.example.com vsftpd[12345]: Connected from client1.example.com[192.0.2.1]
Dec  9 10:00:01 ftp.example.com vsftpd[12345]: USER username: Login successful.
Dec  9 10:00:02 ftp.example.com vsftpd[12345]: Connected from client2.example.com[192.0.2.2]
Dec  9 10:00:03 ftp.example.com vsftpd[12345]: USER username: Login successful.
Dec  9 10:00:04 ftp.example.com vsftpd[12345]: Listing directory /home/username/
Dec  9 10:00:05 ftp.example.com vsftpd[12345]: Disconnected from client1.example.com[192.0.2.1]
Dec  9 10:00:06 ftp.example.com vsftpd[12345]: Disconnected from client2.example.com[192.0.2.2]
~~~

### SIEM and Unix-based tools

SIEM stands for Security Information and Event Management. It is a type of software used to collect, store, analyze, and report on log data from multiple sources. SIEM helps organizations to monitor their IT environment for security threats, detect suspicious activity, and take corrective action. It can also be used to track user activity for compliance purposes. The two most common applications are: Splunk and ELK Stack.

In Unix-based OS, there are very important tools to handle text files and for that log files as well. Some examples are:

* tail, [my cheatsheet]({{ site.baseurl }}{% link _cheatsheets/tail.md %}){:target="_blank"};
* head, [my cheatsheet]({{ site.baseurl }}{% link _cheatsheets/head.md %}){:target="_blank"};
* less, [my cheatsheet]({{ site.baseurl }}{% link _cheatsheets/less.md %}){:target="_blank"};
* grep, [my cheatsheet]({{ site.baseurl }}{% link _cheatsheets/grep.md %}){:target="_blank"};
* egrep, [my cheatsheet]({{ site.baseurl }}{% link _cheatsheets/egrep.md %}){:target="_blank"};
* fgrep, [my cheatsheet]({{ site.baseurl }}{% link _cheatsheets/fgrep.md %}){:target="_blank"};
* find, [my cheatsheet]({{ site.baseurl }}{% link _cheatsheets/find.md %}){:target="_blank"} ;
* locate [my cheatsheet]({{ site.baseurl }}{% link _cheatsheets/locate.md %}){:target="_blank"} ;
* awk [my cheatsheet]({{ site.baseurl }}{% link _cheatsheets/awk.md %}){:target="_blank"} ;
* touch [my cheatsheet]({{ site.baseurl }}{% link _cheatsheets/touch.md %}){:target="_blank"} ;
* echo [my cheatsheet]({{ site.baseurl }}{% link _cheatsheets/echo.md %}){:target="_blank"} ;

## References

### THM resources

[Splunk 101](https://tryhackme.com/room/splunk101){:target="_blank"}.

[Splunk 201](https://tryhackme.com/room/splunk201){:target="_blank"}.

[Intro SIEM](https://tryhackme.com/room/introtosiem){:target="_blank"}.

[Linux Fundamental 1](https://tryhackme.com/room/linuxfundamentalspart1){:target="_blank"}.

[Linux Fundamental 2](https://tryhackme.com/room/linuxfundamentalspart3){:target="_blank"}.

[Linux Fundamental 3](https://tryhackme.com/room/linuxfundamentalspart2){:target="_blank"}.

[Linux Modules](https://tryhackme.com/room/linuxmodules){:target="_blank"}.

### others resources

[Splunk](https://www.splunk.com/)

[ELK Stack](https://www.elastic.co/what-is/elk-stack)
