<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>THM AoC 2022 DAY 18 | pfransozi.github.io</title> <meta name="author" content="Philipe Fransozi"> <meta name="description" content="walking through the 18th day's topics and diving deeper"> <meta property="og:site_name" content="pfransozi.github.io"> <meta property="og:type" content="website"> <meta property="og:title" content="pfransozi.github.io | THM AoC 2022 DAY 18"> <meta property="og:url" content="https://pfransozi.github.io/blog/2022/THM-AoC2022-DAY-18/"> <meta property="og:description" content="walking through the 18th day's topics and diving deeper"> <meta property="og:locale" content="en"> <meta name="twitter:card" content="summary"> <meta name="twitter:title" content="THM AoC 2022 DAY 18"> <meta name="twitter:description" content="walking through the 18th day's topics and diving deeper"> <script type="application/ld+json">
      {
        "author":
        {
          "@type": "Person",
          "name": "Philipe  Fransozi"
        },
        "url": "https://pfransozi.github.io/blog/2022/THM-AoC2022-DAY-18/",
        "@type": "WebSite",
        "description": "walking through the 18th day's topics and diving deeper",
        "headline": "THM AoC 2022 DAY 18",
        "sameAs": ["https://tryhackme.com/p/OutroHomemComum", "https://github.com/pfransozi", "https://www.linkedin.com/in/philipehf"],
        "name": "Philipe  Fransozi",
        "@context": "https://schema.org"
      }
    </script> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.ico"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://pfransozi.github.io/blog/2022/THM-AoC2022-DAY-18/"> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">pfransozi.github.io</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories</a> </li> <li class="nav-item "> <a class="nav-link" href="/links/">links</a> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">THM AoC 2022 DAY 18</h1> <p class="post-meta">December 21, 2022</p> <p class="post-tags"> <a href="/blog/2022"> <i class="fas fa-calendar fa-sm"></i> 2022 </a>   ·   <a href="/blog/tag/threat-detection"> <i class="fas fa-hashtag fa-sm"></i> threat-detection</a>   <a href="/blog/tag/log-analysis"> <i class="fas fa-hashtag fa-sm"></i> log-analysis</a>   <a href="/blog/tag/tryhackme"> <i class="fas fa-hashtag fa-sm"></i> tryhackme</a>   </p> </header> <article class="post-content"> <h2 id="introduction">Introduction</h2> <p>On the 18th day, the focus is the practice of threat detection, which is related to an active role inside an ecosystem that aiming to identify malicious signs of compromise or intrusion within a network.</p> <blockquote> <p>What would be evident is that most of the blue-team activities will require proactive approaches to analyzing different logs, malware and network traffic.</p> </blockquote> <p>At the level we are, other concepts that were already discussed come into play and they are arranged in a relationship to form another one, here called threat detection.</p> <p>So far, a lot of information and logs were gathered and they point to an attack chain. Attack chain was seen on the first day in an introductory and theoretical manner. There, we have seen a little about Cyber Kill Chain, MITRE ATT&amp;CK, and Unified Kill Chain, which are all frameworks that describe the stages in an attack chain.</p> <p>An attack chain is a series of steps that an attacker takes to compromise a target system or network, involving multiple stages, each of which builds upon the previous one and brings the attacker closer to achieving their ultimate goal. Understanding the steps in an attack chain can help organizations and individuals identify and defend against potential attacks by detecting and mitigating vulnerabilities before they can be exploited.</p> <p>Those steps can vary depending on the framework adopted by security team, specific tactics and tools being used, as well as the type of target being attacked. But in general they cover:</p> <ol> <li> <strong>reconnaissance</strong> is the step known for gathering information about the target, such as its IP addresses, domain names, software versions, and network architecture;</li> <li> <strong>initial access</strong> is the step known for finding a way to enter the target system or network, such as by exploiting a vulnerability or using social engineering to trick a user into providing access;</li> <li> <strong>execution</strong> is the step known for running code on the target system, such as malware or a script that allows the attacker to gain further access or privileges;</li> <li> <strong>persistence</strong> is the step known for ensuring that the attacker has a way to maintain access to the target even if the initial access method is discovered or closed. This might involve installing a backdoor or creating a new user account;</li> <li> <strong>privilege escalation</strong> is the step known for gaining higher levels of access or privileges within the target system or network, such as by exploiting a vulnerability or cracking a password;</li> <li> <strong>lateral movement</strong> is the step known for moving from the initial point of entry to other parts of the target system or network, such as by exploiting trust relationships or using other compromised systems as a stepping stone;</li> <li> <strong>data exfiltration</strong> is the step known for stealing sensitive data from the target system or network, such as by transferring it to a remote server or using it to create fake accounts;</li> <li> <strong>cover-up</strong> is the step known for attempting to hide the attack or cover the tracks of the attacker, such as by deleting log files or tampering with forensic evidence;</li> </ol> <p>On the 18th attack scenario, the phases that were observed, based on UKC (Unified Kill Chain), include the following:</p> <ul> <li> <strong>persistence</strong> means that the adversary established persistence by creating a local user account they could use during their attack;</li> <li> <strong>discovery</strong> means that the adversary sought to gather information about their target by running commands to learn about the processes and software on Santa’s devices to search for potential vulnerabilities;</li> <li> <strong>execution</strong> means that the scheduled jobs were created to provide an initial means of executing malicious code. This may also provide them with persistence or be part of elevating their privileges;</li> </ul> <p>Related to those phases there are indicators of compromise (IOCs) and detection parameters.</p> <p>IOCs are signs that a computer or network has been compromised by an attacker, and they can help organizations detect and respond to cyber attacks by providing clues about the nature and extent of the attack. It is important for organizations to monitor for ICOs and to have a plan in place for responding to potential security breaches.</p> <p>Some of IOCs can include:</p> <ul> <li> <strong>malware files or artifacts</strong>, which can include files left behind by malware, such as temporary files or registry keys;</li> <li> <strong>network traffic anomalies</strong>, which is unusual traffic patterns or communication with suspicious IP addresses can be indicators of an ongoing attack;</li> <li> <strong>unauthorized access</strong>, if an attacker has gained access to a system, it could be detected through the use of unauthorized accounts or privileges;</li> <li> <strong>system changes</strong>, if an attacker has made changes to system settings or installed unauthorized software, it could be detected through changes to the system configuration or the presence of unfamiliar programs;</li> <li> <strong>security breaches</strong>, such as the unauthorized disclosure of sensitive data, could be an indicator of a successful attack;</li> </ul> <p>Related to that context, there is detection parameters, which refers to the specific criteria that are used to identify IOCs and potential security breaches. For example, an organization might set detection parameters to flag any network traffic coming from a suspicious IP address or any files that contain a specific piece of malware code. Detection parameters can be used to help automated security systems identify potential threats, or they can be used by security analysts to manually review logs and other data for signs of compromise. Detection parameters can be customized to fit the specific needs and risks faced by an organization. It is important to regularly review and update detection parameters to ensure that they are effective at identifying the latest threats and vulnerabilities.</p> <p>With that in mind, the attack chain report include:</p> <table> <thead> <tr> <th></th> <th>ATTACK TECHNIQUE (ATT&amp;CK)</th> <th>INDICATORS OF COMPROMISE</th> <th>REQUIRED DETECTION FIELDS</th> </tr> </thead> <tbody> <tr> <td>1</td> <td> <a href="" target="_blank" rel="noopener noreferrer">T1136<br>Create Account</a> </td> <td> <ul> <li>EventID: 4720</li> <li>Service: Security</li> </ul> </td> <td> <ul> <li>Service</li> <li>EventID</li> </ul> </td> </tr> <tr> <td>2</td> <td> <a href="https://attack.mitre.org/techniques/T1518/" target="_blank" rel="noopener noreferrer">T1518<br>Software Discovery</a> </td> <td> <ul> <li>Category: Process Creation</li> <li>EventID: 1</li> <li>Service: Sysmon</li> <li>Image: C:\Windows\System32\reg.exe</li> <li>CommandLine: <br> <code> reg query “HKEY_LOCAL_MACHINE\Software\Microsoft\Internet Explorer” /v svcVersion </code> </li> </ul> </td> <td> <ul> <li>Category</li> <li>EventID</li> <li>Image</li> <li>CommandLine Strings</li> </ul> </td> </tr> <tr> <td>3</td> <td> <a href="https://attack.mitre.org/techniques/T1053/005/" target="_blank" rel="noopener noreferrer">T1053.005<br>Scheduled Task</a> </td> <td> <ul> <li>Category: Process Creation</li> <li>EventID: 1</li> <li>Service: Sysmon</li> <li>Image: C:\Windows\System32\schtasks.exe</li> <li>Parent Image: C:\Windows\System32\cmd.exe</li> <li>CommandLine:<br> <code> schtasks /create /tn "T1053_005_OnLogon" /sc onlogon /tr "cmd.exe /c calc.exe" </code> </li> </ul> </td> <td> <ul> <li>Category</li> <li>EventID</li> <li>Image</li> <li>CommandLine strings</li> </ul> </td> </tr> </tbody> </table> <p>Before going further, let’s understand that table:</p> <p><strong>First line</strong> shows a technique called <em>Create Account</em>, by which an attacker creates an account to maintain access to victim systems. And so, it does not require persistent remote access tools to be deployed on the system. *</p> <blockquote> <p>This technique can be used to establish a foothold on a system, allowing the attacker to maintain persistence and access to the system over an extended period of time. And it is part of <em>Persistence</em> tactic.</p> </blockquote> <p>Creating a new user account can be accomplished in a variety of ways, depending on the system and the level of access that the attacker has. For example, an attacker with local administrator privileges may be able to create a new user account directly on the system. An attacker with access to a domain controller may be able to create a new user account within the domain. An attacker with remote access to a system may be able to create a new user account through a remote access tool or by exploiting a vulnerability in the system.</p> <p>The indicator of compromise is determined by an event id, which is EventID 4720. It is a system event that is logged by the <em>Windows Security Log</em> when a new user account is created on both domain and local. The <em>Account Domain</em> field makes the differentiation, registering the domain name or the name of the computer or device that that account belongs to.</p> <p><strong>Second line</strong> shows a technique called <em>Software Discovery</em>, by which an attacker attempts to get a listing of software and software version that are installed on a system.</p> <blockquote> <p>This technique can be used by attackers to gather information about the system and its capabilities, as well as to identify potential vulnerabilities that can be exploited. And it is part of <em>Discovery</em> tactic.</p> </blockquote> <p>There are a number of different methods that attackers can use to discover software on a target system, including:</p> <ul> <li> <strong>Scanning the system</strong> is a method by which attackers can use tools to scan a system and identify the software that is installed;</li> <li> <strong>Examining system configuration files</strong> is a method by which attackers can examine configuration files or registry keys to identify the software that is installed on a system;</li> <li> <strong>Querying system APIs</strong> is a method by which attackers can use system APIs to query the system for information about installed software;</li> <li> <strong>Executing software</strong> is a method by which attackers can execute software on the system to determine its capabilities or to gather information about the system.</li> </ul> <p>Considering the indicator of compromise, that was logged by <em>Sysmon</em>, which is a tool used to monitor and log system activity, we know that the possible attacker creates a process called <em>reg.exe</em>, which is a legitimate system utility that is used to manage the registry on <em>Windows</em> systems. The command executed was <code class="language-plaintext highlighter-rouge">reg query “HKEY_LOCAL_MACHINE\Software\Microsoft\Internet Explorer” /v svcVersion"</code>, querying information about the version of <em>Internet Explorer</em>.</p> <p>On its own, this log entry does not necessarily indicate a compromise or malicious activity. However, it could potentially be indicative of suspicious activity if it is seen in the context of other unusual or suspicious events on the system.</p> <p><strong>Third line</strong> shows a technique called <em>Scheduled Task</em>, by which an attacker abuses the <em>Windows Task Scheduler</em> to perform task scheduling for initial or recurring execution of malicious code.</p> <blockquote> <p>This technique can be used to maintain persistence on a compromised system or to execute malicious actions on a regular basis. And it is part of <em>Execution</em>, <em>Persistence</em>, <em>Privilege Escalation</em> tactics.</p> </blockquote> <p>An adversary may use <em>Windows Task Scheduler</em> to execute programs at system startup or on a scheduled basis for persistence. The <em>Windows Task Scheduler</em> can also be abused to conduct remote execution as part of Lateral Movement and to run a process under the context of a specified account, such as <em>SYSTEM</em>. Adversaries may also create hidden scheduled tasks that may not be visible to defender tools and manual queries used to enumerate tasks.</p> <p>Considering the indicator of compromise, that was as well as logged by <em>Sysmon</em>, we know that the possible attacker creates a process called <em>schtasks</em>, which is a command-line utility in <em>Windows</em> that allows you to create, delete, and manage tasks to run periodically or at a specific time. In our context, the task will execute <code class="language-plaintext highlighter-rouge">cmd.exe /c calc.exe</code> when a user logs on to the system.</p> <p>It’s worth noting that this command could potentially be used in a malicious way, as it could be used to execute arbitrary code or applications when a user logs on to the system. It’s important to be cautious when using <em>schtasks</em> and to ensure that you understand the implications of the tasks you are creating. Using <em>schtasks</em> or any other utility that allows you to execute code on a system can be potentially dangerous if used improperly, for two reasons: <code class="language-plaintext highlighter-rouge">/tr</code> flag is modified to point to a malicious program or even the original program is modified. Both situations can start a malicious version when task is triggered. For that, it’s also a good idea to verify the authenticity and safety of any code or application that you are planning to execute on a system. This can help to prevent accidental or malicious execution of dangerous or undesirable code.</p> <h2 id="sigma">Sigma</h2> <p>Sigma is a generic and open-source SIEM ruleset that allows you to detect security events of interest in your environment.</p> <blockquote> <p>The main purpose of this project is to provide a structured form in which researchers or analysts can describe their once developed detection methods and make them shareable with others.</p> </blockquote> <p>Sigma is meant to be an open standard in which such detection mechanisms can be defined, shared and collected in order to improve the detection capabilities for everyone. For that, Sigma is vendor-agnostic and it can be converted to a format that fits the target SIEM. Let’s see an example:</p> <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">title</span><span class="pi">:</span> <span class="s">Apache Spark Shell Command Injection - Weblogs</span>
<span class="na">id</span><span class="pi">:</span> <span class="s">1a9a04fd-02d1-465c-abad-d733fd409f9c</span>
<span class="na">status</span><span class="pi">:</span> <span class="s">experimental</span>
<span class="na">description</span><span class="pi">:</span> <span class="s">Detects attempts to exploit an apache spark server via CVE-2014-6287 from a weblogs perspective</span>
<span class="na">references</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">https://github.com/W01fh4cker/cve-2022-33891/blob/fd973b56e78bca8822caa3a2e3cf1b5aff5d0950/cve_2022_33891_poc.py</span>
    <span class="pi">-</span> <span class="s">https://sumsec.me/2022/CVE-2022-33891%20Apache%20Spark%20shell%20command%20injection.html</span>
    <span class="pi">-</span> <span class="s">https://github.com/apache/spark/pull/36315/files</span>
<span class="na">author</span><span class="pi">:</span> <span class="s">Nasreddine Bencherchali</span>
<span class="na">date</span><span class="pi">:</span> <span class="s">2022/07/19</span>
<span class="na">tags</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">attack.initial_access</span>
    <span class="pi">-</span> <span class="s">attack.t1190</span>
    <span class="pi">-</span> <span class="s">cve.2022.33891</span>
<span class="na">logsource</span><span class="pi">:</span>
    <span class="na">category</span><span class="pi">:</span> <span class="s">webserver</span>
<span class="na">detection</span><span class="pi">:</span>
    <span class="na">selection</span><span class="pi">:</span>
        <span class="na">c-uri|contains</span><span class="pi">:</span> <span class="s1">'</span><span class="s">?doAs=`'</span>
    <span class="na">condition</span><span class="pi">:</span> <span class="s">selection</span>
<span class="na">falsepositives</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">Web vulnerability scanners</span>
<span class="na">level</span><span class="pi">:</span> <span class="s">high</span>
</code></pre></div></div> <p>It’s an example from <a href="https://github.com/SigmaHQ/sigma/blob/master/rules/web/web_cve_2022_33891_spark_shell_command_injection.yml" rel="external nofollow noopener" target="_blank">github.com/SigmaHQ</a>, and it was designed to detect attempts to exploit a vulnerability in Apache Spark known as <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-33891" rel="external nofollow noopener" target="_blank">CVE-2022-33891</a>.</p> <p>Basically, rule will trigger if <code class="language-plaintext highlighter-rouge">c-uri</code> field in the web server logs contains the string <code class="language-plaintext highlighter-rouge">?doAs=</code>, for instance:</p> <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">GET /spark/bin/spark-class?doAs=`ls%20/etc` HTTP/1.1</span>
<span class="na">Host</span><span class="pi">:</span> <span class="s">example.com</span>
<span class="na">User-Agent</span><span class="pi">:</span> <span class="s">Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/90.0.4430.93 Safari/537.36</span>
<span class="na">Accept</span><span class="pi">:</span> <span class="s">text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span>
<span class="na">Accept-Encoding</span><span class="pi">:</span> <span class="s">gzip, deflate</span>
<span class="na">Accept-Language</span><span class="pi">:</span> <span class="s">en-US,en;q=0.9</span>
<span class="na">Connection</span><span class="pi">:</span> <span class="s">close</span>
</code></pre></div></div> <p>This request is attempting to execute the <code class="language-plaintext highlighter-rouge">ls</code> command on the <code class="language-plaintext highlighter-rouge">/etc</code> directory of the server, which could potentially be used to gather sensitive information about the system. The request includes a parameter in the query string, <code class="language-plaintext highlighter-rouge">doAs='</code>, which is one of the criteria specified in the Sigma rule’s <em>detection</em> section. If this request is sent to an <em>Apache Spark</em> server that is vulnerable to the command injection attack described in CVE-2022-33891, and the Sigma rule is active and configured to monitor web server logs, the rule will trigger and generate an alert.</p> <p>Sigma rules use YAML language, which is:</p> <ul> <li>YAML is case-sensitive;</li> <li>Files should have the .yml extension;</li> <li>Spaces are used for indentation and not tabs;</li> <li>Comments are attributed using the # character;</li> <li>Key-value pairs are denoted using the colon <code class="language-plaintext highlighter-rouge">:</code> character;</li> <li>Array elements are denoted using the dash <code class="language-plaintext highlighter-rouge">-</code> character;</li> </ul> <h2 id="sigma-rule-syntax-and-how-to-create-a-rule">Sigma rule syntax and how to create a rule</h2> <p>Let’s follow THM in the path to understand the structure of a sigma rule file and how to create one.</p> <p>The basic structure is as next:</p> <ul> <li>title (based on what is is supposed to detect)[<code class="language-plaintext highlighter-rouge">required</code>]</li> <li>id (an UUID) [<code class="language-plaintext highlighter-rouge">required</code>]</li> <li>status (stage in which the rule maturity is at while in use)[<code class="language-plaintext highlighter-rouge">optional</code>]</li> </ul> <hr> <p>There are five declared statuses as follow:</p> <ul> <li> <strong>stable</strong>: The rule may be used in production environments and dashboards;</li> <li> <strong>test</strong>: Trials are being done to the rule and could require fine-tuning;</li> <li> <strong>experimental</strong>: The rule is very generic and is being tested. It could lead to false results, be noisy, and identify exciting events;</li> <li> <strong>deprecated</strong>: The rule has been replaced and would no longer yield accurate results;</li> <li> <strong>unsupported</strong>: The rule is not usable in its current state (unique correlation log, homemade fields);</li> </ul> <hr> <p>Continuing:</p> <ul> <li>description (description of the rule and what it does)[<code class="language-plaintext highlighter-rouge">optional</code>]</li> <li>references (a list of references that provide more information about the rule)[<code class="language-plaintext highlighter-rouge">optional</code>]</li> <li>logsource (describes the log data to be used for the detection)[<code class="language-plaintext highlighter-rouge">required</code>]</li> </ul> <hr> <p>It consists of other optional attributes:</p> <ul> <li> <strong>product</strong>: Selects all log outputs of a certain product. Examples are Windows, Apache</li> <li> <strong>category</strong>: Selects the log files written by the selected product. Examples are firewalls, web, and antivirus.</li> <li> <strong>service</strong>: Selects only a subset of the logs. Examples are sshd on Linux or Security on Windows.</li> <li> <strong>definition</strong>: Describes the log source and its applied configurations.</li> </ul> <hr> <p>Continuing:</p> <ul> <li>detection (specifies the conditions that trigger the rule)[<code class="language-plaintext highlighter-rouge">required</code>]</li> </ul> <hr> <p>The parameters are divided into two main parts:</p> <ul> <li> <strong>search identifiers</strong> are the fields and values the detection should search for. The search identifiers can be enhanced using different modifiers appended to the field name with the pipe character |. The main type of modifiers are known as Transformation modifiers and comprise the values: contains, endswith, startswith, and all. Some of these modifiers will be vital in writing rules against the other IOCs.</li> <li> <strong>condition expression</strong> - sets the action to be taken on the detection, such as selection or filtering. The critical thing to look out for account creation on Windows is the Event ID associated with user accounts. In this case, Event ID: 4720 was provided for us on the IOC list, which will be our search identifier.</li> </ul> <hr> <p>Continuing:</p> <ul> <li>falsepositives (A list of known false positives that may occur based on log data)[<code class="language-plaintext highlighter-rouge">optional</code>]</li> <li>level (Describes the severity with which the security team should take the activity under the written rule. The attribute comprises five levels: Informational -&gt; Low -&gt; Medium -&gt; High -&gt; Critical)[<code class="language-plaintext highlighter-rouge">optional</code>]</li> <li>tags (Adds information that can be used to categorize the rule. Common tags are associated with tactics and techniques from the MITRE ATT&amp;CK framework.)[<code class="language-plaintext highlighter-rouge">optional</code>]</li> </ul> <p>At the end, a sigma rule file to detect the incident describes here is:</p> <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">title</span><span class="pi">:</span> <span class="s">Suspicious Local Account Creation</span>
<span class="na">id</span><span class="pi">:</span> <span class="s">0f06a3a5-6a09-413f-8743-e6cf35561297</span> 
<span class="na">status</span><span class="pi">:</span> <span class="s">experimental</span>
<span class="na">description</span><span class="pi">:</span> <span class="s">Detects the creation of a local user account on a computer.</span>
<span class="na">logsource</span><span class="pi">:</span>
  <span class="na">product</span><span class="pi">:</span> <span class="s">windows</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">security</span>
<span class="na">detection</span><span class="pi">:</span>
  <span class="na">selection</span><span class="pi">:</span>
    <span class="na">EventID</span><span class="pi">:</span>  <span class="c1"># This shows the search identifier value</span>
      <span class="pi">-</span> <span class="m">4720</span>    <span class="c1"># This shows the search's list value</span>
    <span class="na">Image|endswith</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">\svchost.exe'</span>
    <span class="na">CommandLine|contains|all</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s">bash.exe</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">-c</span><span class="nv"> </span><span class="s">'</span>   
  <span class="na">condition</span><span class="pi">:</span> <span class="s">selection</span>
<span class="na">falsepositives</span><span class="pi">:</span> 
    <span class="pi">-</span> <span class="s">unknown</span>
<span class="na">level</span><span class="pi">:</span> <span class="s">low</span>
<span class="na">tags</span><span class="pi">:</span>
   <span class="pi">-</span> <span class="s">attack.persistence</span> <span class="c1"># Points to the MITRE Tactic</span>
   <span class="pi">-</span> <span class="s">attack.T1136.001</span> <span class="c1"># Points to the MITRE Technique</span>
</code></pre></div></div> <h2 id="hands-on">Hands-on</h2> <p>To get the information required to close the day, it is request to create three sigma rules based on attack chain report data. One of them is above, other two are next:</p> <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">title</span><span class="pi">:</span> <span class="s">susp-software-discovery</span>
<span class="na">id</span><span class="pi">:</span> <span class="c1"># UUID</span>
<span class="na">status</span><span class="pi">:</span> <span class="c1"># experimental, test, stable, deprecated, unsupported.</span>
<span class="na">description</span><span class="pi">:</span> <span class="s">susp-software-discovery</span>
<span class="na">author</span><span class="pi">:</span>
<span class="na">date</span><span class="pi">:</span>
<span class="na">modified</span><span class="pi">:</span>

<span class="na">logsource</span><span class="pi">:</span> <span class="c1"># Outlines target source of the logs based on operating system, service being run, category of logs.</span>
  <span class="na">product</span><span class="pi">:</span>  <span class="c1"># windows, linux, macos.</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">sysmon</span> <span class="c1"># sshd for Linux, Security for Windows, applocker, .</span>
  <span class="na">category</span><span class="pi">:</span> <span class="s">process_creation</span> <span class="c1"># firewall, web, antivirus, process_creation, network_connection, file_access.</span>
<span class="na">detection</span><span class="pi">:</span>
  <span class="na">selection</span><span class="pi">:</span>
    <span class="na">Image|endswith</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s1">'</span><span class="s">\reg.exe'</span>
    <span class="na">CommandLine|contains|all</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s">reg</span>
      <span class="pi">-</span> <span class="s">query</span>
      <span class="pi">-</span> <span class="s">/v</span>
      <span class="pi">-</span> <span class="s">svcVersion</span>
    <span class="na">EventID</span><span class="pi">:</span> 
     <span class="pi">-</span> <span class="m">1</span>

  <span class="na">condition</span><span class="pi">:</span> <span class="s">selection</span> <span class="c1"># Action to be taken. Can use condition operators such as OR, AND, NOT when using multiple search identifiers.</span>

<span class="na">falsepositives</span><span class="pi">:</span> <span class="c1"># Legitimate services or use.</span>

<span class="na">level</span><span class="pi">:</span>  <span class="c1"># informational, low, medium, high or critical.</span>

<span class="na">tags</span><span class="pi">:</span> <span class="c1"># Associated TTPs from MITRE ATT&amp;CK</span>
  <span class="pi">-</span> <span class="pi">{</span><span class="nv">attack.tactic</span><span class="pi">}</span> <span class="c1"># MITRE Tactic</span>
  <span class="pi">-</span> <span class="pi">{</span><span class="nv">attack.technique</span><span class="pi">}</span> <span class="c1"># MITRE Technique </span>
</code></pre></div></div> <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">title</span><span class="pi">:</span> <span class="s">schtasks-creation</span>
<span class="na">id</span><span class="pi">:</span> <span class="c1"># UUID</span>
<span class="na">status</span><span class="pi">:</span> <span class="c1"># experimental, test, stable, deprecated, unsupported.</span>
<span class="na">description</span><span class="pi">:</span>
<span class="na">author</span><span class="pi">:</span>
<span class="na">date</span><span class="pi">:</span>
<span class="na">modified</span><span class="pi">:</span>

<span class="na">logsource</span><span class="pi">:</span> <span class="c1"># Outlines target source of the logs based on operating system, service being run, category of logs.</span>
  <span class="na">product</span><span class="pi">:</span> <span class="c1"># windows, linux, macos.</span>
  <span class="na">service</span><span class="pi">:</span> <span class="s">sysmon</span> <span class="c1"># sshd for Linux, Security for Windows, applocker, sysmon.</span>
  <span class="na">category</span><span class="pi">:</span> <span class="s">process_creation</span> <span class="c1"># firewall, web, antivirus, process_creation, network_connection, file_access.</span>
<span class="na">detection</span><span class="pi">:</span>
  <span class="na">selection</span><span class="pi">:</span>
   <span class="na">Image|endswith</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="s">\schtasks.exe</span>
   <span class="na">CommandLine|contains|all</span><span class="pi">:</span> 
    <span class="pi">-</span> <span class="s">schtasks</span>
    <span class="pi">-</span> <span class="s">/create</span>
   <span class="na">EventID</span><span class="pi">:</span> 
     <span class="pi">-</span> <span class="m">1</span>

  <span class="na">condition</span><span class="pi">:</span> <span class="s">selection</span> <span class="c1"># Action to be taken. Can use condition operators such as OR, AND, NOT when using multiple search identifiers.</span>

<span class="na">falsepositives</span><span class="pi">:</span> <span class="c1"># Legitimate services or use.</span>

<span class="na">level</span><span class="pi">:</span>  <span class="c1"># informational, low, medium, high or critical.</span>

<span class="na">tags</span><span class="pi">:</span> <span class="c1"># Associated TTPs from MITRE ATT&amp;CK</span>
  <span class="pi">-</span> <span class="pi">{</span><span class="nv">attack.tactic</span><span class="pi">}</span> <span class="c1"># MITRE Tactic</span>
  <span class="pi">-</span> <span class="pi">{</span><span class="nv">attack.technique</span><span class="pi">}</span> <span class="c1"># MITRE Technique </span>
</code></pre></div></div> <h2 id="references">References</h2> <h3 id="thm-references">THM references</h3> <p><a href="https://tryhackme.com/room/yara" target="_blank" rel="external nofollow noopener">YARA</a>.</p> <p><a href="https://tryhackme.com/room/unifiedkillchain" target="_blank" rel="external nofollow noopener">Unified Kill Chain</a>.</p> <p><a href="https://tryhackme.com/room/cyberkillchainzmt" target="_blank" rel="external nofollow noopener">Cyber Kill Chain</a>.</p> <h3 id="other-references">other references</h3> <p><a href="https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/basic-audit-account-management" target="_blank" rel="external nofollow noopener">MS Windows Basic Audit Account Management</a>.</p> <p><a href="https://learn.microsoft.com/en-us/windows/security/threat-protection/auditing/event-4720#security-monitoring-recommendations" target="_blank" rel="external nofollow noopener">MS Windows Security Monitoring Recommendations</a>.</p> <p><a href="https://learn.microsoft.com/en-us/sysinternals/downloads/sysmon" target="_blank" rel="external nofollow noopener">Microsoft SysMon</a>.</p> <p><a href="https://learn.microsoft.com/pt-br/windows-server/administration/windows-commands/schtasks" target="_blank" rel="external nofollow noopener">Microsoft Schtasks</a>.</p> <p><a href="https://www.cvedetails.com/vulnerability-list/vendor_id-26/product_id-9900/Microsoft-Internet-Explorer.html" target="_blank" rel="external nofollow noopener">Microsoft Internet Explorer CVE List</a>.</p> <p><a href="https://yaml.org/" target="_blank" rel="external nofollow noopener">YAM Language</a>.</p> <p><a href="https://github.com/SigmaHQ/sigma" target="_blank" rel="external nofollow noopener">SigmaHQ</a>.</p> <p><a href="https://github.com/SigmaHQ/sigma-specification" target="_blank" rel="external nofollow noopener">Sigma Specification</a>.</p> <p><a href="https://www.nextron-systems.com/2018/02/10/write-sigma-rules/" target="_blank" rel="external nofollow noopener">Sigma Write Rules</a>.</p> <p><a href="https://github.com/virustotal/yara" target="_blank" rel="external nofollow noopener">YARA Repository</a>.</p> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Philipe Fransozi. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Last updated: June 25, 2023. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>